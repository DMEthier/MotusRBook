# Data Checking: Metadata {#checkMetadata}

This chapter provides you with the tools you need to check the completeness and accuracy of your metadata. Data quality for your projects and the projects of others depends on the completeness and accuracy of tag and receiver metadata, because it allows detections to be properly linked to your project, and allows other users to benefit fully from data collected by the Motus network of receivers. 

**Missing or incorrect tag metadata** can result in a lack of tag detections in your data. For example, if deployment date is missing or wrong, the tag finder, which processes the data from each receiver in the network, might not look for your tag in the data, or might not look at the appropriate time when the tag is actually active. This will result in missing tags in your detections data.

**Missing or incorrect receiver metadata** can result in a loss of information for both your project and the projects of other Motus users. For example, missing deployment latitude and longitude can result in a loss of information on the location of a receiver and therefore tag detections. Particularly when the same receiver is moved from one location to another, it is important that your metadata reflect this move, so that you and other users can properly analyze your/their data. Missing antenna deployments, including port number, height and orientation, can also limit what users can do with their data. For example, departure orientation cannot be estimated without the latitude, longitude, orientation, height, antenna type, and port of each antenna. If orientation isn't something you are interested in, please keep in mind that other Motus users with tags detected on your receivers might be. We therefore encourage you to enter *all* tower and antenna metadata, even if it may not seem relevant to your own project goals.

We use the James Bay Shorebird Monitoring Project sample dataset throughout this chapter (see Section \@ref(sampleData). As you run through the code to check metadata for your own project, **please fix metadata errors or omissions in your project by signing in to <https://motus.org/>**, and under the 'Manage Data' tab, select either 'Manage Tags' to fix tag deployment metadata or 'Manage Receivers' to fix receiver deployment metadata. It is important to fix metadata errors online, so that errors are fixed at the source and archived on the Motus Server, ensuring all users have access to the correct tag and receiver metadata.

## Load relevant R packages

```{r loadPackages.4, warning = FALSE, message = FALSE}

library(devtools)
library(tidyverse)
library(lubridate)    ## for working with dates
library(motusdata)    ## repository for sample datasets for this book

```

## Check Tag Metadata {#tagMetadata}

In your .motus file, you are provided with the metadata for tags registered to your own project, and for duplicate tags from other projects associated with ambiguous detections in your data. The main things we want to check with tag metadata are:

1. how many tags are registered to your project;
2. how many of those registered tags were deployed;
3. location of tag deployments;
4. timing of tag deployments;
3. completeness and accuracy of tag deployment metadata.

We will run through each of these in sequence.

### Number of registered tags

To check the number of registered tags, load the 'df.tags' RDS file for the James Bay Shorebird Monitoring Project, which was created using the 'createFlatFiles' function in Section \@ref(flatRDSfunction), and can be accessed here by loading the motusdata R package, which we did above. 

The 'df.tags' file contains the characteristics of each registered tag, including a unique tagID and information on manufacturer, model, nominal and offset frequency, burst interval, and pulse length. We select the metadata specific to the James Bay Shorebird Monitoring Project, and ignore tag metadata associated with any duplicate tags belonging to other projects:


```{r importTags, message = FALSE, warning = FALSE}

df.tags <- readRDS("./data/df.tags.RDS")
df.tags <- df.tags %>% filter(projectID == 38)

```

The number of rows in the 'df.tags' database is equivalent to the number of tags registered to the James Bay Shorebird Monitoring Project. There are 691 tags registered to the project (recall we are using just a subset of this dataset):

```{r nRegisteredTags}

nrow(df.tags) ## number of registered tags in the database

```
If this number does not correspond with the number of tags that were registered with Motus, go through the list of tagIDs, determine which tags are missing, and ensure that they are indeed registered online at <https:motus.org/tag-registration>. If they are registered but are not showing in your tag metadata, please contact motus@birdscanada.org with details on the tag and deployment IDs in question.

### Number of registered tags that were deployed

The tag deployment table ('df.tagDeps') is required to check which registered tags have deployments, as it includes the date, time, species, and location of tag deployment. The database is subset to project '38', and selected columns are merged with the 'df.tags' table to determine which registered tags have (or do not have) corresponding deployment information.

```{r importTagMeta.4, message = FALSE, warning = FALSE}

df.tagDeps <- readRDS("./data/df.tagDeps.RDS")                                        
df.tagDeps <- filter(df.tagDeps, projectID == 38) 

## merge with tag registration metadata:

df.tagsDeployed <- full_join(df.tags, select(df.tagDeps, deployID, tagID), by = "tagID")

```

List registered tags that do not have associated deployment metadata:

```{r tagsRegNotDeployed}

filter(df.tagsDeployed, is.na(deployID))

```

Two of the 691 registered tags do not have deployment metadata, which suggests they were not deployed. Records should be checked to ensure this is the case, and if the tags were deployed, deployment metadata should be entered for these tags online at <https://motus.org>. Without deployment metadata, detections for registered but 'undeployed' tags will be missing from your detections database.

### Location of tag deployments

Creating a map of your tag deployments can point out any obvious errors in the tag deployment latitude or longitude.

1. **Install R mapping package.**

If you do not have rworldmap installed then you must install and load the package into R first:

```{r installMapPackagesRecv, message = FALSE, warning = FALSE}

install.packages("rworldmap")
require(rworldmap)

```

2. **Load base map files.**

```{r loadMapsRecv, message = FALSE, warning = FALSE}

na.lakes <- map_data(map = "lakes")
na.lakes <- mutate(na.lakes, long = long- 360)

## Include the countries that make sense

na.map <- subset(map_data(map="world2"), 
                region %in% c("Canada", "USA")) 
                
## Others (Americas): "Mexico", "lakes","Belize", "Costa Rica", "Panama", "Guatemala", "Honduras", "Nicaragua", "El Salvador", "Colombia", "Venezuela", "Ecuador", "Peru", "Brazil", "Guyana","Suriname", "Bolivia", "French Guiana", "Jamaica", "Cuba", "Haiti", "Dominican Republic", "The Bahamas", "Turks and Caicos Islands", "Puerto Rico", "British Virgin Islands", "Montserrat", "Dominica", "Saint Lucia", "Barbados", "Grenada", "Trinidad and Tobago", "Chile", "Argentina", "Uruguay"

na.map <- mutate(na.map, long = long- 360)

```

3. **Map the locations of tag deployments.**

The following maps the location of tag deployments for project 38. Plotting the deployments is a great way to see any odd deployment locations. If any deployment locations stand out as potentially incorrect, those should be subset, and metadata for those deployments checked and fixed (where appropriate) online at <https://motus.org>.

```{r mapRecvs}

## set limits to map based on locations of detections, ensuring they include the deployment locations
xmin <- -100 #min(df.tagDeps$longitude, na.rm = TRUE) - 5
xmax <- max(df.tagDeps$longitude, na.rm = TRUE) + 5
ymin <- min(df.tagDeps$latitude, na.rm = TRUE) - 5
ymax <- max(df.tagDeps$latitude, na.rm = TRUE) + 5
                
## map
ggplot(na.lakes, aes(long, lat))+ 
  geom_polygon(data = na.map, aes(long, lat, group=group), colour = "grey", fill="grey98")+#
  geom_polygon(aes(group = group), colour = "grey", fill = "white")+
  coord_map(projection="mercator", xlim = c(xmin, xmax), ylim = c(ymin, ymax))+
  xlab("") + ylab("") + 
  theme_bw() + 
  geom_point(data = df.tagDeps, aes(longitude, latitude), cex = 2, pch = 1, colour = "red")
   
```
Note that there is a warning that 164 rows were removed from the map due to missing values. Exploring these using `r summary(df.tagDeps), eval = FALSE`, we see that 164 deployments are missing speciesID, latitude, and longitude. Comparing the tagIDs for these records in the 'df.tagDeps' file with the deployments of those tags online at <https://motus.org>, these tags were registered but either not deployed or used as test tags. Each deployment with missing metadata should be checked carefully, and missing metadata entered online for any tags that were actually deployed.

### Timing of tag deployments

Plotting tag deployment times can be a good way to check for odd or overlapping deployment dates for the same tag deployed more than once.

```{r plotTagDeps}

## put data in long format first
df.tagDeps.long <- select(df.tagDeps, tagID, deployID, tsStart, tsEnd) %>% gather(when, ts,c(tsStart, tsEnd))

## for purpose of book, subset to tags with detections data
df.alltags <- readRDS("./data/df.alltagswithambigs.rds")
df.tagDeps.long <- filter(df.tagDeps.long, tagID %in% unique(df.alltags$motusTagID))

ggplot(df.tagDeps.long, aes(y = as.factor(tagID), x = ts, colour = as.factor(deployID))) +
  geom_line() + theme_bw() +
  ylab("Tag ID") + xlab("Year") + scale_colour_discrete(guide = guide_legend(title ="Tag deployment ID"))

```
In this case, tags were deployed in fall 2015 or 2016, and each tag was deployed only once. 

### Check completeness and accuracy of tag metadata

Required tag metadata includes deployment start date/time, end date/time (if applicable), deployment latitude, deployment longitude, and species. Lack of information on deployment date, time, and location in particular can influence the estimated lifespan of your tag, and therefore whether the tagFinder will 'look' for your tag at the appropriate time(s). It can also increase the potential for ambiguities with duplicate tags in the system. 

1. **Look at range of metadata values**.

As a first step, use summary(df.tagDeps) to get an idea of the range of each variable, and whether any variables have missing (NA) or odd values in the data. The following summarizes a subset of the variables in the df.tagDeps database. There are several things to consider: are the range of start and end dates reasonable for your deployments, or are there obvious errors in the timing of deployments? Is the range in deployment latitude and longitude values reasonable? Are the values for species IDs correct?  

```{r summaryTagMeta}

summary(select(df.tagDeps, deployID, tagID, projectID, tsStart, tsEnd, speciesID, latitude, longitude))

```

There are no missing start and end dates (tsStart/tsEnd), and deployment start dates range from `r min(year(df.tagDeps$tsStart)` to `r max(year(df.tagDeps$tsStart)`, which is reasonable for this project. However, as we saw above, there are `r length(df.tagDeps$speciesID[is.na(df.tagDeps$speciesID)])` records missing speciesID, latitude, and longitude. 

The species IDs are numeric, and somewhat meaningless without an ability to assign an actual species name to the numeric ID, which we do in step 3. 

2. **Check for missing or odd values in metadata**.

We know from summary(df.tagDeps) above that there are no missing deployment dates in the tag metadata. The following code confirms this by listing any deployments from the project with missing deployment start and/or end date (of which there are none). You can modify the filter as required to search for any missing or odd values in any parameter of the database that you notice using summary().

```{r missingTagDeployDate}

filter(df.tagDeps, is.na(tsStart)|is.na(tsEnd)) %>% select(deployID, tagID, projectID, tsStart, tsEnd)

```

3. **Check that species IDs are appropriate for your data**.

The 'df.species' RMD file associates each numeric species ID with an english, french, and scientific name. We import that table, and subset to the suite of numeric speciesIDs in your tag metadata:

```{r checkSpecies}

## Species metadata
df.species <- readRDS("./data/df.species.rds")

## list of species IDs in project 38 metadata
sp.list <- unique(df.tagDeps$speciesID)     ## generate list of speciesIDs in the tag metadata
df.species %>% 
        filter(id %in% sp.list) %>% 
        collect() %>% 
        as.data.frame()                     ## subset and convert to a flat file

```

This lists all species that are included in the tag deployment metadata for the project. If there are species that do not make sense, this is likely due to a data entry error when assigning a deployment to a species. You can look for records in your tag metadata that are associated with a particular speciesID using the following code; you would then use the deployID associated with the entry/entries to find and update the deployment record in your project metadata online at <https://motus.org>:

```{r listMetaSpecies}

filter(df.tagDeps, speciesID == 5000)

```

## Check Receiver Metadata {#recvMetadata}

There are two sources of receiver metadata in Motus detections data: receivers registered to your own project, and receivers registered to the projects of others. You are provided access to the metadata for all receivers in the network, because negative data (i.e., my tag was *not* detected at tower x even though it was active) is often as important as positive data. It also allows you to map where your tags were detected relative to the distribution of receivers throughout the Motus network.

Receiver metadata errors or ommissions that you find in your .motus file can only be fixed for receivers registered to your own project. All users are encouraged to enter complete and accurate receiver metadata for the benefit of the entire network. If there are metadata missing for receivers registered to others, and the missing metadata is required for your own analyses, please contact motus@birdscanada.org with an appropriate level of detail about the missing metadata (e.g., projectID, recvDeployID). Please also use the Motus listserve to request that other registered users record the receiver deployment details you will need; please be specific about the exact receiver deployment details you are interested in, and when and where in the network your tags will be deployed and potentially detected. 

The main things we want to check with receiver metadata are:

1. number of network-wide registered receivers;
2. number of network-wide receiver deployments;
3. number of project-specific receiver deployments;
4. location of network-wide and project receiver deployments;
5. timing of project receiver deployments;
6. completeness and accuracy of receiver metadata.

### Number of network-wide registered receivers

To check the number of registered Motus receivers, load the 'df.recvs' table from the .motus file. This file contains a device ID and a serial number for each receiver. This table does not provide the number of deployments for each receiver, or when and where the receivers were deployed:

```{r importRecvs, message = FALSE, warning = FALSE}

df.recvs <- readRDS("./data/df.recvs.rds")
nrow(df.recvs)

```

There are currently `r nrow(df.recvs)` receivers registered in the Motus network.

### Number of network-wide receiver deployments

Each registered receiver can be deployed more than once. The receiver deployment metadata table 'df.recvDeps' contains information on each deployment, including the location and time:

```{r importRecvDeps}

df.recvDeps <- readRDS("./data/df.recvDeps.rds")
nrow(recvDeps)

```

There have been `r nrow(df.recvDeps)` network-wide receiver deployments since `r min(date(df.recvDeps$tsStart), na.rm = TRUE)`. A simple histogram shows the type of receiver deployed, and how many deployments per receiver:

```{r histDeps}

ggplot(df.recvDeps, aes(x = deviceID, fill = receiverType)) + 
  geom_bar() + 
  theme_bw() + 
  ggtitle("Number of deployments per receiver") +
  ylab("# Deployments") +
  scale_fill_discrete(name = "Receiver Type")

```

### Number of project-specific receiver deployments

To see which of the deployments are registered to your project, subset and summarize the data:

```{r projectDeps}

df.projRecvs <- filter(df.recvDeps, projectID == 38)     # replace with your own projectID for your own data. 
summary(df.projRecvs)

```

There are `r nrow(df.projRecvs)` receiver deployments registered to project 38. Four deployments are missing latitude and longitude, and two deployments are missing end dates, which suggests those receivers are still deployed. 

If the number of receiver deployments in the metadata does not correspond with the number of field deployments, check the list of receiver deployIDs, determine which receivers or deployments are missing, and register them online at <https:motus.org>. Missing receiver registrations will result in a complete lack of detections data for that receiver, and missing deployments can result in tag detections in your database that aren't associated with a receiver deployment, i.e., information on receiver location and station set-up (antenna type, orientation, etc) will not be available.  

The timing of deployments can be displayed graphically; horizontal line(s) in the following plot show the time span for each deployment for each receiver (deviceID) registered to the James Bay Shorebird Monitoring project. Different deployments of the same should not overlap in time:

```{r projectRecvDeploy, warnings = FALSE, messages = FALSE}

# put data in long format first

df.projRecvs.long <- select(df.projRecvs, deviceID, deployID, tsStart, tsEnd) %>% gather(when, ts,c(tsStart, tsEnd))

ggplot(df.projRecvs.long, aes(y = as.factor(deviceID), x = ts, colour = as.factor(deployID))) +
  geom_line() + theme_bw() +
  ylab("Receiver ID") + xlab("Year") + scale_colour_discrete(guide = guide_legend(title ="Receiver deployment ID"))

```
### Location of receiver deployments

Plot the location of project-specific and network-wide receivers using a simple plot of latitude against longitude, and then on a map of North America for better context. 

#### Simple Plot of receiver locations

```{r simpleRecvPlot, message = FALSE, warning = FALSE}

# use as.logical to show whether deployments are from your project or not
ggplot(df.recvDeps, aes(y = latitude, x = longitude, colour = as.logical(projectID == 38))) +
  geom_point(pch = 1) +
  theme_bw() +
  ggtitle("Location of Motus receiver deployments")+
  scale_colour_discrete(name = "Project 38 Deployment")  # don't need legend name

```

Not all receivers were deployed at the same time or during your study period. The plot can be restricted to receivers that were active during your study period by placing filters on date. For example, to restrict the plot to receivers that were active in 2016 (not evaluated here):

```{r mapRecvLocationsbyTime, eval = FALSE, message = FALSE, warning = FALSE}

ggplot(filter(df.recvDeps, year(tsStart) <= 2016 & year(tsEnd) >= 2016), aes(y = latitude, x = longitude, colour = as.logical(projectID == 38))) +
  geom_point(pch = 1) +
  theme_bw() +
  ggtitle("Location of Motus receiver deployments active at some point in 2016")+
  scale_colour_discrete(name = "Project 38 deployment")  # don't need legend name

```
#### Map of receiver locations

Maps provide better spatial context; plot the location of receivers on a map:

1. **Install R mapping package.**

Install and load the 'rworldmap' package into R:

```{r installMapPackagesRecv, message = FALSE, warning = FALSE}

install.packages("rworldmap")
require(rworldmap)

```

2. **Load base map files.**

```{r loadMapsRecv, message = FALSE, warning = FALSE}

na.lakes <- map_data(map = "lakes")
na.lakes <- mutate(na.lakes, long = long- 360)

# Include all of the Americas to begin

na.map <- subset(map_data(map="world2"), 
                region %in% c("Canada", "USA", "Mexico", "lakes",
                               "Belize", "Costa Rica", "Panama", 
                               "Guatemala", "Honduras", "Nicaragua", 
                               "El Salvador", "Colombia", "Venezuela", "Ecuador", "Peru", "Brazil",
                               "Guyana","Suriname", "Bolivia", "French Guiana", "Jamaica", "Cuba", 
                               "Haiti", "Dominican Republic", "The Bahamas", "Turks and Caicos Islands", 
                               "Puerto Rico", "British Virgin Islands", "Montserrat", "Dominica", "Saint Lucia", 
                               "Barbados", "Grenada", "Trinidad and Tobago", "Chile", "Argentina", 
                               "Uruguay"))

na.map <- mutate(na.map, long = long- 360)

```

3. **Map the locations of receivers in the Americas.**

Map showing the location of network-wide receivers (dark grey 'x') and receivers deployed by the James Bay Shorebird Monitoring Project (project 38; red 'x').

```{r mapRecvs, message = FALSE, warning = FALSE}

# set limits to map based on locations of detections, ensuring they include the deployment locations
xmin <- min(df.recvDeps$longitude, na.rm = TRUE) - 2
xmax <- -20 # restrict to the Americas (excluding a few points in Europe)
ymin <- min(df.recvDeps$latitude, na.rm = TRUE) - 2
ymax <- max(df.recvDeps$latitude, na.rm = TRUE) + 2
                
# map
ggplot(na.lakes, aes(long, lat))+ 
  geom_polygon(data = na.map, aes(long, lat, group=group), colour = "grey", fill="grey98")+#
  geom_polygon(aes(group = group), colour = "grey", fill = "white")+
  coord_map(projection="mercator", xlim = c(xmin, xmax), ylim = c(ymin, ymax))+
  xlab("") + ylab("") + 
  theme_bw() + 
  geom_point(data = df.recvDeps, aes(longitude, latitude, colour = as.logical(projectID == 38)), cex = 0.8, pch = 4)+
  scale_colour_manual(values = c("grey30", "red"), name = "Project 38 Deployment") 
  

```

4. **Map the locations of project specific receivers.**

Map of project-specific receivers, created by setting the x-axis (longitude) and y-axis (latitude) map limits using the 'df.projRecvs' dataframe created above. Deployments are restricted to those that were active at in 2016.

```{r mapProjRecvs, message = FALSE, warning = FALSE}

# set limits to map based on locations of detections, ensuring they include the deployment locations
xmin <- min(df.projRecvs$longitude, na.rm = TRUE) - 2
xmax <- max(df.projRecvs$longitude, na.rm = TRUE) + 2
ymin <- min(df.projRecvs$latitude, na.rm = TRUE) - 1
ymax <- max(df.projRecvs$latitude, na.rm = TRUE) + 1
                
# map
ggplot(na.lakes, aes(long, lat))+ 
  geom_polygon(data = na.map, aes(long, lat, group=group), colour = "grey", fill="grey98")+#
  geom_polygon(aes(group = group), colour = "grey", fill = "white")+
  coord_map(projection="mercator", xlim = c(xmin, xmax), ylim = c(ymin, ymax))+
  xlab("") + ylab("") + 
  theme_bw() + 
  geom_point(data = filter(df.projRecvs, year(tsStart) >= 2016 & year(tsEnd) <= 2016), aes(longitude, latitude, colour = as.factor(deviceID)), cex = 2, pch = 1)+
  scale_colour_discrete(name  =  "Receiver ID") 

```

### Completeness and accuracy of receiver metadata

Users have access to the metadata for all receivers in the network. While most users will be conserned primarily with the metadata for receivers with detections of their own tags, metadata for receivers without detections can be useful to estimate parameters like detection probability. The following summaries will check for the completeness and accuracy of metadata for all receivers in the network, recognizing that any errors or omissions can only be fixed by the project that deployed the receiver. 

1. **Load receiver and antenna metadata**

Generate a list of all receiver deployments with detections in our database using:

```{r recvList}

deployList <- unique(filteredAmbigs$recvDeployID)

```


1. **Look at range of metadata values**. INCLUDES DATA FROM ALL RECEIVERS IN NETWORK.

As with the tag metadata, we use summary() to get a general idea of the distribution of the variables in the data. We see that there are 25 records with missing lat/lon and 5 records with missing start time, both of which are integral to mapping the location of detections. Many (270) records are missing deployment end time, but this is not unusual, because some deployments might be permanent, or not have a specific planned end date. Finally, 1193 records are missing elevation. Elevation is not necessary to map the location of detections, so is not a required field. However, some analyses might require elevation, and we recommend filling this in when possible. Alternatively, elevation might be estimated directly in R (for example, see <https://stackoverflow.com/questions/8973695/conversion-for-latitude-longitude-to-altitude-in-r>).

```{r SummaryRecv}

summary(recvMeta)

```

If you see any odd values, you can subset them out using filter(), e.g., the following filters out receivers with a longitude > 7, which appears to be odd. It turns out that this device was deployed on Helgoland in the North Sea

```{r recvMetaFilter}

filter(recvMeta, longitude > 7)

```


2. **List receivers registered to your project*:**.

If you deployed your own receivers, you can check which receivers are registered to your project using the following code, which drops some variables, and arranges the remaining records by receiver ID, latitude, and startDate:

```{r checkRegisteredReceivers}

filter(recvMeta, projectID == 38) %>% select(-serno,-fixtureType, -macAddress, isMobile, -tsStart, -tsEnd, -elevation, - projectID) %>% arrange(deviceID, latitude, dateStart)

```

We can see from these records that four of the deployments are missing latitude and longitude information. However, looking at the 'name' and 'isMobile' columns, we see that these are likely all mobile receivers, which aren't associated with a fixed latitude and longitude. 'isMobile' is 0 for deployIDs 3813 and 3814, despite being named as mobile receivers. The classification of these receivers, if truly mobile, should be changed online at <https://motus.org> under receiver deployments for this project.


3. **Check metadata for receiver deployments with detections**.

If you are missing any receivers, please register them online through your project management page

Each receiver requires a deployment which includes a deployment name, site, station type, deployment start/end dates/times, latitude, longitude, and antenna properties including port number, antenna type, and bearing. To view a full list of your current deployments:

***INSERT CODE***

To view which current deployments are missing required information:

***INSERT CODE***

Any missing receiver metadata needs to be updated online.

If you have updated any metadata online, you'll need to force an update on the data you have downloaded, it's good practice to check for updates prior to any analysis as other users may have updated metadata associated with your detection files:

```{r tagme5, eval = FALSE}

t <- tagme(projRecv = 123, forceMeta = TRUE)

```

