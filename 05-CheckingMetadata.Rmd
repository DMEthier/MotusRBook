# Data Checking: Metadata {#checkMetadata}

This chapter provides you with the tools you need to check the completeness and accuracy of your metadata. Data quality for your projects and the projects of others depends on the completeness and accuracy of tag and receiver metadata, because it allows detections to be properly linked to your project, and allows other users to benefit fully from data collected by the Motus network of receivers. 

**Missing or incorrect tag metadata** can result in a lack of tag detections in your data. For example, if deployment date is missing or wrong, the tag finder, which processes the data from each receiver in the network, might not look for your tag in the data, or might not look at the appropriate time when the tag is actually active. This will result in missing tags in your detections data.

**Missing or incorrect receiver metadata** can result in a loss of information for both your project and the projects of other Motus users. For example, missing deployment latitude and longitude can result in a loss of information on the location of a receiver and therefore tag detections. Particularly when the same receiver is moved from one location to another, it is important that your metadata reflect this move, so that you and other users can properly analyze your/their data. Missing antenna deployments, including port number, height and orientation, can also limit what users can do with their data. For example, departure orientation cannot be estimated without the latitude, longitude, orientation, height, antenna type, and port of each antenna. If orientation isn't something you are interested in, please keep in mind that other Motus users with tags detected on your receivers might be. We therefore encourage you to enter *all* tower and antenna metadata, even if it may not seem relevant to your own project goals.

As you run through the following code to check your metadata, **please fix metadata errors or omissions in your project by signing in to <https://motus.org/>**, and under the 'Manage Data' tab, select either 'Manage Tags' to fix tag deployment metadata or 'Manage Receivers' to fix receiver deployment metadata. It is important to fix metadata errors online, so that errors are fixed at the source and archived on the Motus Server, ensuring all users have access to the correct tag and receiver metadata.

## Load relevant R packages

```{r loadPackages.4, warning = FALSE, message = FALSE}

library(devtools)
library(tidyverse)
library(lubridate)    # for working with dates
library(motusdata)    # repository for sample datasets for this book

```

## Import .motus file

We will run through how to check for and deal with ambiguities using our sample dataset from the James Bay Shorebird Monitoring Project (see Section \@ref(sampleData)). We recommend that you run through the sample code in each chapter with the sample dataset **before** running through with your own data, because you may need to modify the code or the order of the steps we take in order to deal most effectively with your own ambiguities (every situation is different).

```{r importdata}

file.name <- system.file("extdata", "project-sample.motus", package = "motusdata")    ## or replace with file.name <-  "C:/data/project-123.motus" using your file directory
t <- dplyr::src_sqlite(file.name)

```


## Check Tag Metadata {#tagMetadata}

In your .motus file, you are provided with the tag metadata for tags registered to your own project, and for duplicate tags from other projects associated with ambiguous detections in your data. Because we already dealt with ambiguous detections in Chapter \@ref(ambiguities), we restrict this section to metadata for tags registered to our own project. 

The main things we want to check with tag metadata are:

1. how many tags are registered to your project;
2. how many registered tags were deployed;
3. how many deployed tags had detections;
4. whether required metadata are complete and accurate.

We will run through each of these in sequence.

### Number of registered tags

To check the number of registered tags, we need to load the 'tags' metadata table from the .motus file. This file contains the characteristics of each registered tag, including a unique tagID and information on manufacturer, model, nominal and offset frequency, burst interval, and pulse length:

```{r importTags, message = FALSE, warning = FALSE}

file.name <- system.file("extdata", "project-sample.motus", package = "motusdata") # or <- "C:/data/project-123.motus" using your file directory
t <- dplyr::src_sqlite(file.name)                                             
tags <- tbl(t, "tags")                                                   # extract tagDeps table, with tag deployment metadata
tags <- tags %>% filter(projectID == 38) %>% collect %>% as.data.frame   # convert tag metadata to a flat file

```

We can see the number of tags registered to our project by simply counting the number of rows, which tells us that 691 tags are registered to the James Bay Shorebird Monitoring Project (recall we are using just a subset of this dataset):

```{r nRegisteredTags}

nrow(tags) # number of registered tags in the database

```
If this number does not correspond with the number of tags you actually registered, you will need to go through the list, determine which tags are missing, and register them online at <https:motus.org/tag-registration>. Once tags are registered, detections will not be available for those tags until receiver data is re-processed.

### Number of registered tags that were deployed

To check which of your registered tags were deployed, you will look at the tag deployment metadata in the 'tagDeps' table of the .motus file. This file contains information on date, time, species, and location of deployment. We subset to our project ('38' for the sample data), and merge selected columns of the 'tagDeps' table with the 'tags' table to determine which registered tags have (or don't have) corresponding deployment information.

Import tag deployment metadata:

```{r importTagMeta.4, message = FALSE, warning = FALSE}

tagMeta <- tbl(t, "tagDeps")                                                   # extract tagDeps table, with tag deployment metadata
tagMeta <- tagMeta %>% filter(projectID == 38) %>% collect %>% as.data.frame   # convert tag metadata to a flat file
tagMeta <- mutate(tagMeta, dateStart = date(as_datetime(tagMeta$tsStart)),
                           dateEnd= date(as_datetime(tagMeta$tsEnd)))     # create a date variable for the start of the deployment

```

Merge with the tag registration metadata:

```{r whichTagsDeployed, message = FALSE, warning = FALSE}

deplTags <- full_join(tags, select(tagMeta, deployID, tagID), by = "tagID")

```

List registered tags that were not deployed, and therefore lack a unique deployment ID:

```{r tagsRegNotDeployed}

filter(deplTags, is.na(deployID))

```

In this case, two of the 691 registered tags do not have deployment metadata, which suggests they were not deployed. Please check your records to ensure that this is correct. If the tags were deployed, please enter deployment metadata for these tags online at <https://motus.org>, otherwise detections for these tags will be missing from your .motus database.

### Number of deployed tags with detections.

There are several reasons why registered and deployed tags might not be included in the detections data, including:

1) the tag was not properly activated on deployment. To avoid this, always check that a tag is active using a hand-held receiver before attaching the tag to your study animal and releasing it. 

2) an animal with a properly activated tag might not pass within range of a receiving station. Study designs that incorporate strategic placement of receivers to meet project goals can improve your odds of getting detections of your tags.

3) missing or incorrect tag deployment metadata can result in the tagFinder not 'looking' for your tag at the time the tag was deployed, or at all. Incorrect metadata can also be a concern if there are duplicate tags in the system; the tagFinder will only assign detections as ambiguous during the lifetime of your tag, which is estimated based on metadata. If your metadata are incorrect, there is the potential for detections of your tags that occur *outside* the estimated lifespan to be assigned unambiguously to a duplicate tag from another project, and not assigned to your tag at all. 

The following code creates a database 'nDetect' which calculates the number of detections of each deployed tag in the 'filteredAmbigs' database. 

```{r tagsWithDetections}

nDetect <- full_join(select(filteredAmbigs, motusTagID, tagDeployID) %>% group_by(motusTagID, tagDeployID) %>% summarize(nDetect = n()), 
                      select(tagMeta, tagID, deployID) %>% distinct() %>% as.data.frame, by = c("motusTagID" = "tagID", "tagDeployID" = "deployID")) %>%
                      as.data.frame
```

To list all tagIDs which have detections, you can run the following code; recall that we are using a small sample of the James Bay Shorebird Monitoring Project data, so only those tags included in the sample dataset will have detections here:

```{r tagsWithDetections}
filter(nDetect, nDetect > 0) %>% select(motusTagID) %>% as.list()
```

And generate a list of tags without detections, of which there are 671 because we are using only a subset of the full dataset (not evaluated here):

```{r tagsWithoutDetections, eval = FALSE}
filter(nDetect, is.na(nDetect)) %>% select(motusTagID) %>% as.list()
```

If you notice that you are missing detections for deployed tags that you believe should have been detected, the first step is to check that your metadata are complete and accurate, which we do next.

### Check completeness and accuracy of tag metadata

Required tag metadata includes deployment start date/time, end date/time (if applicable), deployment latitude, deployment longitude, and species.  Lack of information on deployment date, time, and location in particular can influence the estimated lifespan of your tag, and therefore whether the tagFinder will 'look' for your tag at the appropriate time(s), and/or influence the potential for ambiguities with duplicate tags in the system. 

1. **Look at range of metadata values**.

Using summary(tagMeta), you can get a general idea of which variables in the tag metadata are missing (look for NA values) or have odd values. Here we summarize just those variables we are most interested in; if you want to look at all variables, simply use summary(tagMeta). There are several things to look at here: are the range of start and end dates reasonable for your deployments, or are there obvious errors in the timing of deployments? Is the range in deployment latitude and longitude reasonable? Are the values for species IDs correct?  

```{r summaryTagMeta}

summary(select(tagMeta, deployID, tagID, projectID, dateStart, dateEnd, speciesID, latitude, longitude))

```

There are no missing start and end dates (tsStart/tsEnd), and deployment dates range from 2014-2017. However, there are 164 records missing speciesID, latitude, and longitude. There is also at least one odd longitude of -980.69, which is an obvious typo. The species IDs are numeric, and somewhat meaningless without an ability to assign an actual species name to the numeric ID, which we do next. 

1. **Check that species IDs are appropriate for your data**.

There is a table in your .motus file called 'species', which associates each numeric species ID with an english, french, and scientific name. We import that table, and subset to the suite of numeric speciesIDs in your tag metadata:

```{r checkSpecies}

sp.list <- unique(tagMeta$speciesID)                                             # generate list of speciesIDs in the tag metadata
species <- tbl(t, "species")                                                     # load species table from the .motus file
species <- species %>% filter(id %in% sp.list) %>% collect %>% as.data.frame     # subset and convert to a flat file
species

```

The species listed should correspond to the species you tagged. If there are species that do not make sense, this is likely due to a data entry error when assigning a deployment to a species. You can look for records in your tag metadata that are associated with a particular speciesID using the following code; you would then use the deployID associated with the entry/entries to find and update the deployment record in your project metadata online at <https://motus.org>:

```{r listMetaSpecies}

filter(tagMeta, speciesID == 5000)

```

2. **Check for missing metadata**.

We already know from summary(tagMeta) above that there are no missing deployment dates in the tag metadata. The following code confirms this by listing any deployments from our project with missing deployment start and/or end date (of which there are none). 

```{r missingTagDeployDate}

filter(tagMeta, is.na(tsStart)|is.na(tsEnd)) %>% select(deployID, tagID, projectID, tsStart, tsEnd)

```

We can do the same for speciesID, latitude, and longitude. Because there are 164 rows with missing speciesID, latitude, and longitude, we only show the first few records with missing data here. Should you have missing metadata in your own files, please take note of the relevant deployIDs and use your field notes to fix the records online at <https://motus.org>.

```{r missingTagDeployDate, eval = FALSE}

missingMeta <- filter(tagMeta, is.na(speciesID)) %>% select(deployID, tagID, projectID, tsStart, tsEnd, speciesID, latitude, longitude, comments)
head(missingMeta)

# if you want to write the database of missing metadata to .csv file:
# write.csv(missingMeta, file = "./data/missingTagMetadata.csv", row.names = FALSE)
```

3. **Check odd parameter values**.

The following code provides us with the deployment ID and tag ID of the metadata record with the odd longitude value that we saw earlier. We can use this information to find the appropriate deployment record online at <https://motus.org>, and fix the longitude of the deployment at the source, as opposed to here on our local database. 

```{r checkLongitude}

filter(tagMeta, longitude < -100)

```

## Check Receiver Metadata {#recvMetadata}

There are two sources of receiver metadata in your detections data: receivers registered to your own project, and receivers registered to the projects of others. You are provided access to the metadata for all receivers in the network, because negative data (i.e., my tag was *not* detected at tower x even though it was active) is often as important as positive data. It also allows you to map where your tags were detected relative to the distribution of receivers throughout the Motus network.

You can only fix receiver metadata errors or ommissions for receivers registered to your own project. We encourage all users to enter complete and accurate receiver metadata for the benefit of the entire network. Unfortunately, we cannot guarantee that all users will record every detail of receiver deployments, including details on antenna orientation (see \@ref(antennaMetadata) below) that you may need. 

If there are metadata missing for receivers registered to others, and you require the missing metadata for your own analyses, please contact motus@birdscanada.org with an appropriate level of detail about the missing metadata (e.g., projectID, recvDeployID). We also encourage you to use the Motus listserve to request that other registered users record the receiver deployment details you will need; please be specific about the exact receiver deployment details you are interested in, and when and where in the network your tags will be deployed and potentially detected. 

The main things we want to check with receiver metadata are:

1. number of network-wide registered receivers;
2. number of network-wide receiver deployments;
3. number of project-specific receiver deployments;
4. location of network-wide and project receiver deployments;
5. completeness and accuracy of receiver metadata.

### Number of network-wide registered receivers

To check the number of registered Motus receivers, we load the 'recvs' table from the .motus file. This file contains a device ID and a serial number for the unit. This table therefore gives the total number of units, and not the number of deployments (each unit can be deployed more than once, for example, if a receiver is moved to another study area, it is then a new deployment of the same receiver deviceID):

```{r importRecvs, message = FALSE, warning = FALSE}

recvs <- tbl(t, "recvs")                                                   # extract tagDeps table, with tag deployment metadata
recvs <- recvs %>% collect %>% as.data.frame   # convert tag metadata to a flat file
nrow(recvs)

```

We see that there are `r nrow(recvs)` receivers registered in the Motus network.

### Number of network-wide receiver deployments

Each registered receiver might have been deployed numerous times. We load the receiver deployment metadata table 'recvDeps' from the .motus file and manipulate the deployment date variables: 

```{r importRecvDeps}

recvDeps <- tbl(t, "recvDeps")                                                   # extract tagDeps table, with tag deployment metadata
recvDeps <- recvDeps %>% collect %>% as.data.frame    # number of registered tags in the database
recvDeps <- mutate(recvDeps,
                          tsStart = as_datetime(tsStart, tz = "GMT", origin = "1970-01-01"),
                          tsEnd = as_datetime(tsEnd, tz = "GMT", origin = "1970-01-01"),
                          yrStart = year(tsStart), 
                          dateStart = date(tsStart),
                          yrEnd = year(tsEnd), 
                          dateEnd = date(tsEnd))
nrow(recvDeps)
```

There have been `r nrow(recvDeps)` network-wide receiver deployments since `r min(recvDeps$dateStart, na.rm = TRUE)'. A simple histogram will give us an idea of the type of receiver deployed, and how many deployments per receiver:

```{r histDeps}

ggplot(recvDeps, aes(x = deviceID, fill = receiverType)) + 
  geom_bar() + 
  theme_bw() + 
  ggtitle("Number of deployments per receiver") +
  ylab("# Deployments") +
  scale_fill_discrete(name = "Receiver Type")

```
### Number of registered receivers without deployment metadata

We can also quickly check whether each registered receiver was deployed at least once; in this case we get 0 rows, i.e., all registered receivers have at least one deployment in the metadata:

```{r recvDeployNum}

left_join(recvs, select(recvDeps, deviceID, deployID, projectID), by = "deviceID") %>% filter(is.na(deployID))

```

### Number of project-specific receiver deployments

To see which of the deployments are registered to your project, subset and summarize the data:

```{r projectDeps}

projRecvs <- filter(recvDeps, projectID == 38)     # replace with your own projectID for your own data. 
summary(projRecvs)

```

There are `r nrow(projRecvs)` receiver deployments registered to the project. Four deployments are missing latitude and longitude, and two deployments are missing end dates, which could mean they are still deployed. 

If the number of receiver deployments in the metadata does not correspond with the number of deployments in the field, you will need to go through the list of receiver deployIDs, determine which receivers or deployments are missing, and register them online at <https:motus.org>. Missing receiver registrations will result in a complete lack of detections data for that receiver, and missing deployments can result in tag detections in your database that aren't associated with a deployment and associated information on the station characteristics (latitude, longitude, antenna type, orientation, etc).  

The timing of deployments can also be displayed graphically; horizontal line(s) in the following plot show the time span for each deployment of every receiver (deviceID) registered to the James Bay Shorebird Monitoring project. Different deployments of the same should not overlap in time:

```{r projectRecvDeploy, warnings = FALSE, messages = FALSE}

# put data in long format first

recvLong <- select(projRecvs, deviceID, deployID, tsStart, tsEnd) %>% gather(when, ts,c(tsStart, tsEnd))
recvLong <- mutate(recvLong, ts = as_datetime(ts, tz = "GMT", origin = "1970-01-01"))

ggplot(recvLong, aes(y = as.factor(deviceID), x = ts, colour = as.factor(deployID))) +
  geom_line() + theme_bw() +
  ylab("deviceID") + xlab("Year") + scale_colour_discrete(guide = guide_legend(title ="Receiver deployment ID"))

```
### Location of receiver deployments

We plot the location of project-specific and network-wide receivers first using a simple plot of latitude against longitude, and then on a map of North America. 

#### Simple Plot of receiver locations

```{r simpleRecvPlot, message = FALSE, warning = FALSE}

# use as.logical to show whether deployments are from your project or not
ggplot(recvDeps, aes(y = latitude, x = longitude, colour = as.logical(projectID == 38))) +
  geom_point(pch = 1) +
  theme_bw() +
  ggtitle("Location of all Motus receiver deployments")+
  scale_colour_discrete(name = "Project 38 Deployment")  # don't need legend name

```

Not all receivers were deployed at the same time, or during your study period. You can restrict the plot to receivers that were active during your study period by placing filters on date. For example, if you want to restrict the plot to receivers that were active in 2016, you can do the following (not evaluated here):

```{r mapRecvLocationsbyTime, eval = FALSE, message = FALSE, warning = FALSE}

ggplot(filter(recvDeps, yrStart <= 2016 & yrEnd >= 2016), aes(y = latitude, x = longitude, colour = as.logical(projectID == 38))) +
  geom_point(pch = 1) +
  theme_bw() +
  ggtitle("Location of all Motus receiver deployments active at some point in 2016")+
  scale_colour_discrete(name = "Project 38 deployment")  # don't need legend name

```
#### Map of receiver locations

Because maps provide better spatial context, we also plot the location of receivers on a map:

1. **Install R mapping package.**

If you do not have rworldmap installed then you must install and load the package into R first:

```{r installMapPackagesRecv, message = FALSE, warning = FALSE}

install.packages("rworldmap")
require(rworldmap)

```

2. **Load base map files.**

```{r loadMapsRecv, message = FALSE, warning = FALSE}

na.lakes <- map_data(map = "lakes")
na.lakes <- mutate(na.lakes, long = long- 360)

# Include all of the Americas to begin

na.map <- subset(map_data(map="world2"), 
                region %in% c("Canada", "USA", "Mexico", "lakes",
                               "Belize", "Costa Rica", "Panama", 
                               "Guatemala", "Honduras", "Nicaragua", 
                               "El Salvador", "Colombia", "Venezuela", "Ecuador", "Peru", "Brazil",
                               "Guyana","Suriname", "Bolivia", "French Guiana", "Jamaica", "Cuba", 
                               "Haiti", "Dominican Republic", "The Bahamas", "Turks and Caicos Islands", 
                               "Puerto Rico", "British Virgin Islands", "Montserrat", "Dominica", "Saint Lucia", 
                               "Barbados", "Grenada", "Trinidad and Tobago", "Chile", "Argentina", 
                               "Uruguay"))

na.map <- mutate(na.map, long = long- 360)

```

3. **Map the locations of receivers in the Americas.**

Map showing the location of network-wide receivers (dark grey 'x') and receivers deployed by the James Bay Shorebird Monitoring Project (project 38; red 'x').

```{r mapRecvs, message = FALSE, warning = FALSE}

# set limits to map based on locations of detections, ensuring they include the deployment locations
xmin <- min(recvDeps$longitude, na.rm = TRUE) - 2
xmax <- -20 # restrict to the Americas (excluding a few points in Europe)
ymin <- min(recvDeps$latitude, na.rm = TRUE) - 2
ymax <- max(recvDeps$latitude, na.rm = TRUE) + 2
                
# map
ggplot(na.lakes, aes(long, lat))+ 
  geom_polygon(data = na.map, aes(long, lat, group=group), colour = "grey", fill="grey98")+#
  geom_polygon(aes(group = group), colour = "grey", fill = "white")+
  coord_map(projection="mercator", xlim = c(xmin, xmax), ylim = c(ymin, ymax))+
  xlab("") + ylab("") + 
  theme_bw() + 
  geom_point(data = recvDeps, aes(longitude, latitude, colour = as.logical(projectID == 38)), cex = 0.8, pch = 4)+
  scale_colour_manual(values = c("grey30", "red"), name = "Project 38 Deployment") 
  

```

4. **Map the locations of project specific receivers.**

Map of project-specific receivers, created by setting the x-axis (longitude) and y-axis (latitude) map limits using the 'projRecvs' dataframe created above. Deployments are restricted to those that were active at in 2016.

```{r mapProjRecvs, message = FALSE, warning = FALSE}

# set limits to map based on locations of detections, ensuring they include the deployment locations
xmin <- min(projRecvs$longitude, na.rm = TRUE) - 2
xmax <- max(projRecvs$longitude, na.rm = TRUE) + 2
ymin <- min(projRecvs$latitude, na.rm = TRUE) - 1
ymax <- max(projRecvs$latitude, na.rm = TRUE) + 1
                
# map
ggplot(na.lakes, aes(long, lat))+ 
  geom_polygon(data = na.map, aes(long, lat, group=group), colour = "grey", fill="grey98")+#
  geom_polygon(aes(group = group), colour = "grey", fill = "white")+
  coord_map(projection="mercator", xlim = c(xmin, xmax), ylim = c(ymin, ymax))+
  xlab("") + ylab("") + 
  theme_bw() + 
  geom_point(data = filter(projRecvs, yrStart >= 2016 & yrEnd <= 2016), aes(longitude, latitude, colour = as.factor(deviceID)), cex = 2, pch = 4)+
  scale_colour_discrete(name  =  "Receiver ID") 

```

### Completeness and accuracy of receiver metadata

Users have access to the metadata for all receivers in the network. We will do a few summaries to check for the completeness and accuracy of metadata for all receivers with detections of your tags. 

1. **Load receiver and antenna metadata**

We can generate a list of all receiver deployments with detections in our database using:

```{r recvList}

deployList <- unique(filteredAmbigs$recvDeployID)

```


1. **Look at range of metadata values**. INCLUDES DATA FROM ALL RECEIVERS IN NETWORK.

As with the tag metadata, we use summary() to get a general idea of the distribution of the variables in the data. We see that there are 25 records with missing lat/lon and 5 records with missing start time, both of which are integral to mapping the location of detections. Many (270) records are missing deployment end time, but this is not unusual, because some deployments might be permanent, or not have a specific planned end date. Finally, 1193 records are missing elevation. Elevation is not necessary to map the location of detections, so is not a required field. However, some analyses might require elevation, and we recommend filling this in when possible. Alternatively, elevation might be estimated directly in R (for example, see <https://stackoverflow.com/questions/8973695/conversion-for-latitude-longitude-to-altitude-in-r>).

```{r SummaryRecv}

summary(recvMeta)

```

If you see any odd values, you can subset them out using filter(), e.g., the following filters out receivers with a longitude > 7, which appears to be odd. It turns out that this device was deployed on Helgoland in the North Sea

```{r recvMetaFilter}

filter(recvMeta, longitude > 7)

```


2. **List receivers registered to your project*:**.

If you deployed your own receivers, you can check which receivers are registered to your project using the following code, which drops some variables, and arranges the remaining records by receiver ID, latitude, and startDate:

```{r checkRegisteredReceivers}

filter(recvMeta, projectID == 38) %>% select(-serno,-fixtureType, -macAddress, isMobile, -tsStart, -tsEnd, -elevation, - projectID) %>% arrange(deviceID, latitude, dateStart)

```

We can see from these records that four of the deployments are missing latitude and longitude information. However, looking at the 'name' and 'isMobile' columns, we see that these are likely all mobile receivers, which aren't associated with a fixed latitude and longitude. 'isMobile' is 0 for deployIDs 3813 and 3814, despite being named as mobile receivers. The classification of these receivers, if truly mobile, should be changed online at <https://motus.org> under receiver deployments for this project.


3. **Check metadata for receiver deployments with detections**.

If you are missing any receivers, please register them online through your project management page

Each receiver requires a deployment which includes a deployment name, site, station type, deployment start/end dates/times, latitude, longitude, and antenna properties including port number, antenna type, and bearing. To view a full list of your current deployments:

***INSERT CODE***

To view which current deployments are missing required information:

***INSERT CODE***

Any missing receiver metadata needs to be updated online.

If you have updated any metadata online, you'll need to force an update on the data you have downloaded, it's good practice to check for updates prior to any analysis as other users may have updated metadata associated with your detection files:

```{r tagme5, eval = FALSE}

t <- tagme(projRecv = 123, forceMeta = TRUE)

```

